# Driiva — Current sprint (tickets)

**External memory for AI sessions:** Work on the next unchecked ticket only; update this list when done.

---

## Sprint: "Make It Real" (Week 1–2)

*If you've already done keys, Firebase login, deploy, or Root contact, check those off.*

- [ ] Create Anthropic account and set API key as Firebase secret
- [ ] Run `firebase login` and authenticate
- [ ] Deploy Cloud Functions (`firebase deploy --only functions`)
- [ ] Deploy Firestore rules and indexes
- [ ] Contact Root Platform for sandbox credentials
- [x] Fix CORS (restrict to driiva.com) — *done: server uses `CORS_ORIGINS` env, no wildcard; set to driiva.com in prod*
- [x] Add password reset flow — *done: /forgot-password page + "Forgot password?" link in signin + route registered in App.tsx*
- [ ] Test full flow: signup → onboarding → record trip → see score → see AI insights

## Sprint: "Make It Safe" (Week 3–4)

- [x] Set up Sentry for error monitoring (frontend + Cloud Functions) — *done: client/src/lib/sentry.ts + functions/src/lib/sentry.ts; SentryErrorBoundary in main.tsx; wrapFunction/wrapTrigger helpers*
- [x] Add Content Security Policy headers — *done: added to server/middleware/security.ts securityHeaders; 'unsafe-inline' for style-src documented (required by Tailwind/Leaflet)*
- [x] Set up GitHub Actions CI/CD pipeline — *done: .github/workflows/ci.yml; jobs: lint-and-typecheck, build (client+server), functions-build, test; triggers on push/PR to main*
- [x] Write first batch of tests (auth flow, scoring algorithm, trip processing) — *done: 103 tests passing across 5 files; auth-flow.test.tsx covers email/password validation, domain blocklist, ProtectedRoute guards, demo mode, username resolution*
- [ ] Set up staging Firebase project
- [x] Add Firebase Analytics initialisation — *done: getAnalytics() in client/src/lib/firebase.ts; guarded by VITE_FIREBASE_MEASUREMENT_ID; try/catch for ad-blocker safety*
- [x] Implement email verification — *done: sendEmailVerification() in signup.tsx; emailVerified field on User type in AuthContext; ProtectedRoute redirects unverified users to /verify-email; verify-email.tsx page with resend + check flow; /quick-onboarding skips check*
- [x] Backend & database security audit — *done: 12 issues found and fixed across Firestore rules, PostgreSQL, Cloud Functions, and API routes. See DRIIVA_CHANGELOG.md for full details.*

## Sprint: "Make It Payable" (Week 5–6)

- [ ] Build Stripe checkout for premium payments
- [ ] Build Stripe webhook handlers (payment success, subscription changes)
- [ ] Wire premium payments to community pool contributions
- [ ] Test Root Platform quote → accept → policy flow end-to-end
- [ ] Add premium amount display on policy page
- [ ] Set `ENCRYPTION_KEY` env var in production (required — server now refuses to store telematics data without it)

## Sprint: "Make It Polished" (Week 7–8)

- [x] Add push notifications (trip complete, score update, payment due) — *done: FCM init in firebase.ts, firebase-messaging-sw.js service worker, usePushNotifications hook, Cloud Function triggers on trip complete + achievement unlock, sendWeeklySummary scheduled function (Mondays 9AM UK)*
- [ ] Build service worker for offline/PWA support
- [x] Fix dashboard map — was hardcoded to London; now requests device GPS on load, handles permission denied and GPS unavailable states gracefully
- [x] Wire up profile page to real data — *done: Member since reads from Firestore createdAt; policyNumber never hardcoded; displayName falls back to fullName field; memberSince added to DashboardData*
- [x] Tier 3 animation polish (Revolut-level) — *done: ScoreRing radial gauge replaces flat bar; dashboard cards use container/item stagger variants; BottomNav has whileTap spring scale + layoutId sliding indicator; trip cards have whileHover lift; onboarding steps use scaleIn with elastic easing*
- [x] Implement trip route visualisation on map (show the actual driven path, not just current position) — *done: TripRouteMap component with Polyline + start/end markers; TripDetail page at /trips/:tripId; trip cards clickable in trips list*
- [ ] Phone usage detection for scoring
- [x] Build achievements backend — *done: 8 achievement definitions in functions/src/utils/achievements.ts; checkAndUnlockAchievements called after trip completion; Firestore collections (achievements/{id}, users/{uid}/achievements/{achId}); seedAchievements admin callable; frontend wired to real data*
- [x] Weather API integration — *done: Open-Meteo archive API in functions/src/utils/weather.ts; maps WMO codes to clear/cloudy/rain/snow/fog/storm; 3s timeout + graceful null fallback; wired into both trip triggers in trips.ts*

## Remaining features not yet in any sprint

These are known gaps that don't have tickets yet:

- [x] **Weather API** — *done: Open-Meteo archive API (free, no key). `functions/src/utils/weather.ts` fetches WMO weather codes and maps to clear/cloudy/rain/snow/fog/storm. Wired into trip processing triggers. 3s timeout, graceful fallback to null.*
- [ ] **Root Platform credentials** — scaffolded but not wired. Needs sandbox creds from Root to test quote → bind → policy flow. Once wired, the `/api/insurance` endpoints become live.
- [ ] **Stripe wiring** — dependencies installed, tables exist, webhooks scaffolded. Premium payments and pool contributions not yet connected end-to-end.
- [x] **Profile page real data** — *done: profile.tsx reads from useDashboardData hook; edit mode for name/phone/vehicle writes to Firestore via updateDoc; loading skeletons on every section; error state with retry*
- [x] **Trip route visualisation** — TripRouteMap component + TripDetail page wired.
- [ ] **Phone pickup detection** — scoring has a 10% weight for phone usage but it's hardcoded to 100 (no penalty). Needs accelerometer pattern recognition to detect phone pickups while driving.
- [x] **Push notifications** — FCM wired end-to-end: trip complete, achievement unlock, weekly summary.
- [x] **Leaderboard rank recalculation** — Firestore scheduled function now filters weekly/monthly by lastTripAt period bounds and uses dense ranking for tied scores. PG table remains stale (not primary).
- [x] GDPR data export — implemented GET /api/gdpr/export/:userId; returns JSON of all user data
- [x] GDPR data delete — implemented DELETE /api/gdpr/delete/:userId; strictly rate-limited
- [x] **Achievements backend** — 8 definitions, unlock logic in Cloud Functions, frontend wired to real Firestore data.
- [ ] **WebAuthn/Passkey login** — `server/webauthn.ts` is scaffolded but not exposed as a real login flow in the frontend.
- [ ] **Staging environment** — no Firebase staging project exists yet. Recommended before any production payments go live.

## Completed (reference)

- [x] Cloud Functions build fixed
- [x] Trips page wired to real Firestore data
- [x] AI insights feature flag
- [x] Root Platform integration scaffolded
- [x] CORS fixed (origin allowlist via `CORS_ORIGINS`; no wildcard)
- [x] CLAUDE.md, ROADMAP.md, and ARCHITECTURE.md added; trip-processor source of truth; regression report and investor doc
- [x] Dashboard map now uses device GPS instead of hardcoded London coordinates
- [x] AI Risk Scoring & Insights engines finalized
- [x] GDPR export/delete endpoints live
- [x] Sentry set up (error monitoring)

---

*Update the checkbox when a ticket is done. Add new tickets at the top of the relevant sprint.*
